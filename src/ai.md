# Kommune Quiz — AI Context Document

Use this document to understand the project, coding style, architecture, and what to work on next.

## What This Is

An interactive map quiz game where players identify Norwegian kommuner (municipalities) by clicking on them on an SVG map. Built with React + TypeScript + Vite, deployed to Cloudflare Pages.

## Tech Stack

- **React 19** with React Compiler (auto-memoization — avoid manual `useCallback`/`useMemo` where the compiler handles it; the compiler will warn via ESLint if manual memoization conflicts)
- **TypeScript** (strict)
- **Vite** (bundler)
- **d3-geo** (projection/path generation only — no D3 DOM manipulation)
- **topojson-client** (converting TopoJSON → GeoJSON features, `mesh` for border extraction)
- **No component library** — plain CSS with CSS custom properties, dark theme ("Nordic Cartographer")

## Coding Style & Conventions

- **Norwegian UI text**: all user-facing strings are in Norwegian ("Finn:", "Hopp over", "feil", "Ferdig!", "Spill igjen", "Start på nytt", "Hele Norge")
- **English code**: all variable names, comments, file names are in English, except domain terms (`kommune`, `fylke`, `kommunenummer`, `fylkesnummer`, `fylkenavn`) which stay Norwegian since they're the actual data field names
- **Small files**: each file is single-responsibility, under ~100 lines, independently replaceable by AI
- **Types first**: all shared interfaces in `src/types/` with barrel exports
- **Hooks for logic**: game state and data loading live in hooks, components are presentational
- **Props down**: components receive data via props, no direct hook calls for shared state
- **Hooks use `useCallback`/`useMemo`**: Hooks still use manual memoization since they aren't compiled the same way as components. If the compiler ESLint warns about mismatched deps, remove the manual memoization.
- **CSS**: flat single file `src/styles/index.css`, class-based with CSS custom properties (`:root` variables), no CSS modules. Specificity matters — use `.parent.child` selectors when overriding base styles.

## Data

Two TopoJSON files generated by `scripts/prepare-data.mjs`:

- **`src/data/kommuner.json`** — 357 kommuner, each with properties: `{kommunenummer, navn, fylkesnummer, fylkenavn}`
- **`src/data/fylker.json`** — 15 fylker boundaries, each with: `{fylkesnummer, fylkenavn}`

The `kommunenummer` first 2 digits = `fylkesnummer`. This is how we link kommuner to fylker.

Run `node scripts/prepare-data.mjs` to regenerate from upstream (robhop/fylker-og-kommuner, CC BY 4.0).

### Coat of Arms (Kommunevåpen)

`scripts/download-shields.mjs` downloads coat of arms images from Wikidata/Wikimedia Commons to `public/shields/{kommunenummer}.png`. These are displayed next to the target kommune name in the game header via `KommuneShield`. The component gracefully hides itself if the image doesn't exist.

## Project Structure

```
src/
├── types/
│   ├── geo.ts              # KommuneFeature, KommuneProperties, KommunePath
│   ├── game.ts             # GameMode, GameState
│   └── index.ts            # Barrel export
├── utils/
│   └── geo.ts              # Custom Mercator projection + viewBox computation
├── hooks/
│   ├── useMapData.ts       # Loads TopoJSON → KommuneFeature[]
│   ├── useGameState.ts     # Shuffle, guess, skip, restart, auto-reset on feature change
│   └── useTimer.ts         # Stopwatch (elapsed seconds, reset, formatTime)
├── components/
│   ├── Game.tsx            # NOT CURRENTLY USED — was an alternative architecture (see notes)
│   ├── map/
│   │   ├── GameMap.tsx      # SVG container: renders ALL kommuner, zooms viewBox to active subset
│   │   ├── KommuneShape.tsx # Single <path>, supports isSolved + isInactive states
│   │   ├── MagnifyingLens.tsx  # Circular zoom lens overlay
│   │   └── FylkeBorders.tsx # Internal fylke borders via topojson.mesh (always visible)
│   └── ui/
│       ├── GameHeader.tsx   # Target name + shield, fylke hint, progress bar, errors, timer, skip, restart
│       ├── KommuneShield.tsx # Displays kommune coat of arms image, hides on error
│       ├── LensToggle.tsx   # Generic toggle button
│       └── FylkeSelector.tsx # Dropdown: "Hele Norge" or specific fylke
├── styles/
│   └── index.css           # All styles (CSS custom properties, "Nordic Cartographer" theme)
├── App.tsx                  # Root orchestrator
└── main.tsx                 # Entry point
```

## Data Flow

```
App
├── useMapData() → features (all 357 kommuner, loaded once)
├── selectedFylke state → filters features into activeFeatures
├── useGameState(activeFeatures) → game state (auto-resets when features change)
├── useTimer(!isComplete) → elapsed time
│
├── GameHeader ← {currentName, currentFylke, currentKommunenummer, showFylke, progress, errors, elapsed, onSkip, onRestart}
│   └── KommuneShield ← {kommunenummer} (shows coat of arms next to target name)
├── Toolbar
│   ├── FylkeSelector ← {fylker list, selected, onChange}
│   ├── LensToggle (lens)
│   └── LensToggle (fylke hint)
└── GameMap ← {allFeatures, activeFeatures, lensEnabled, solved, onGuess}
    ├── KommuneShape[] (ALL kommuner rendered, inactive ones dimmed)
    ├── FylkeBorders (always visible, internal borders only)
    └── MagnifyingLens (conditional, only shows active kommuner)
```

## Key File Details

### `src/utils/geo.ts` — Projection

Custom Mercator projection because d3's `fitSize` doesn't work with this TopoJSON data. Key function:

- `createPathGenerator(allFeatures)` → returns `{ pathGenerator, computeViewBox, viewBox }`
- `pathGenerator` converts GeoJSON features to SVG path `d` strings
- `computeViewBox(subsetFeatures)` computes a viewBox that zooms to any subset while keeping the same projection. When subset === all, returns full Norway viewBox.

The projection is always based on ALL features (full Norway). This means all paths are in the same coordinate space regardless of which fylke is selected. The zoom is achieved by changing the SVG `viewBox`, not the projection.

### `src/components/map/GameMap.tsx` — Map Rendering

This is the most complex component. Key architecture:

- Receives `allFeatures` (all 357) and `activeFeatures` (filtered subset or all)
- Builds paths from `allFeatures` (everything is always rendered)
- Builds `activeSet` from `activeFeatures` for quick lookup
- `isFiltered = activeFeatures.length < allFeatures.length`
- Each KommuneShape gets `isInactive={isFiltered && !isActive}`
- ViewBox zooms to `activeFeatures` via `computeViewBox`
- Lens only shows `activePaths` (filtered to active kommuner)
- `noop` callback for inactive kommuner's `onSelect`

### `src/components/map/FylkeBorders.tsx` — Border Rendering

Uses `topojson.mesh(topology, object, (a, b) => a !== b)` to extract only internal borders (arcs shared by two different fylker). This eliminates coastline rendering. Rendered as a single `<path>` element, always visible, `pointer-events: none`. Imports fylker data from a relative path (`../../../data/fylker.json`).

### `src/hooks/useGameState.ts` — Game Logic

- Shuffles kommuner order on init
- Tracks: currentIndex, errors, solved set
- `handleGuess`: correct → mark solved + advance; wrong → increment errors
- `handleSkip`: append current target to end of order, advance index
- `handleRestart`: reshuffle, reset everything
- **Auto-reset on feature change**: uses `useRef` + `useEffect` to detect when the `features` array reference changes (fylke switch) and resets automatically

### `src/components/map/KommuneShape.tsx` — Individual Kommune

Memoized with `React.memo`. Builds className from state:
- Base: `kommune-shape`
- Solved: `kommune-solved` (green)
- Inactive: `kommune-inactive` (dimmed, not clickable)

Click handler is `undefined` (not just noop) when solved or inactive, preventing pointer events.

### `src/components/ui/KommuneShield.tsx` — Coat of Arms

Displays the kommune coat of arms (`/shields/{kommunenummer}.png`) next to the target name. Uses local `useState` to track load failures — if the image 404s, the component returns `null`. Sized at 28px by default.

### `src/components/Game.tsx` — NOT IN USE

This was created as an alternative architecture where Game encapsulates game state + timer and gets remounted via `key` when fylke changes. The current App.tsx does NOT use this — it manages game state directly. This file can be deleted or repurposed.

## Current CSS Theme — "Nordic Cartographer"

Uses CSS custom properties defined in `:root`. Fonts: DM Sans (body) + JetBrains Mono (timer/mono). Imported via Google Fonts.

| Element | Variable | Value |
|---------|----------|-------|
| Page background | `--bg-deep` | `#080b14` |
| Surface background | `--bg-surface` | `#0f1524` |
| Elevated background | `--bg-elevated` | `#161d30` |
| Active unsolved kommune | `--kommune-fill` | `#1a2238` |
| Active hover | `--kommune-hover` | `#243050` |
| Kommune stroke | `--kommune-stroke` | `#0d111c` |
| Solved kommune | `--accent-solved-dark` | `#145a42` |
| Inactive kommune | `--kommune-inactive` | `#111627` |
| Inactive stroke | `--kommune-inactive-stroke` | `#1a1f30` |
| Fylke borders | — | `rgba(255,255,255,0.12)` |
| Target text | `--accent-target` | `#f0c456` (golden) |
| Error count | `--accent-error` | `#f07068` |
| Complete text | `--accent-solved` | `#2dd4a0` |
| Primary text | `--text-primary` | `#e4e8f1` |
| Secondary text | `--text-secondary` | `#8892a8` |
| Muted text | `--text-muted` | `#5a6478` |

## Features Implemented

- ✅ Click-to-guess game with 357 kommuner
- ✅ Magnifying lens (3x zoom, toggleable)
- ✅ Fylke hint toggle (shows fylke name next to target)
- ✅ Fylke borders (always visible, internal only)
- ✅ Skip button (re-queues kommune at end)
- ✅ Timer (mm:ss, stops on completion)
- ✅ Restart (reshuffle + reset)
- ✅ Fylke selector (play just one fylke, map zooms to fit)
- ✅ Inactive fylke coloring (dimmed kommuner outside selected fylke)
- ✅ Progress bar (visual indicator of completion)
- ✅ Kommune coat of arms (kommunevåpen) shown next to target name

## Wishlist / Next Features

1. **Write mode** — type kommune name instead of clicking (autocomplete input)
2. **Score persistence** — localStorage best times per fylke
3. **Mobile support** — touch handling, responsive layout
4. **Accessibility** — keyboard navigation, ARIA labels

## Notes for AI

- When modifying CSS, use the CSS custom properties defined in `:root` for consistency
- The projection in `geo.ts` is the most sensitive code — changing it breaks the entire map
- `useGameState` auto-resets when its `features` array reference changes, so switching fylke triggers a game reset without needing explicit reset calls (though timer needs manual reset via `resetTimer()`)
- All TopoJSON parsing happens at build time (static imports), no runtime fetches
- FylkeBorders uses `mesh` not `feature` — this is important for getting only internal borders
- FylkeBorders imports fylker data via relative path `../../../data/fylker.json`, not from `src/data/`
- KommuneShield gracefully handles missing images — no need to ensure every kommune has a shield